/*
 * jsTree 0.9.7
 * http://jstree.com/
 *
 * Copyright (c) 2009 Ivan Bozhanov (vakata.com)
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 * Date: 2009-04-08
 *
 */
(function(e){function t(){return typeof t.inst=="undefined"&&(t.cntr=0,t.inst={},t.drag_drop={isdown:!1,drag_node:!1,drag_help:!1,init_x:!1,init_y:!1,moving:!1,origin_tree:!1,marker:!1,move_type:!1,ref_node:!1,appended:!1,foreign:!1,droppable:[],open_time:!1,scroll_time:!1},t.mousedown=function(n){var r=e(n.target);return t.drag_drop.droppable.length&&r.is("."+t.drag_drop.droppable.join(", ."))?(t.drag_drop.drag_help=e("<li id='dragged' class='dragged foreign "+n.target.className+"'><a href='#'>"+r.text()+"</a></li>"),t.drag_drop.drag_node=t.drag_drop.drag_help,t.drag_drop.isdown=!0,t.drag_drop.foreign=r,r.blur(),n.preventDefault(),n.stopPropagation(),!1):(n.stopPropagation(),!0)},t.mouseup=function(e){var n=t.drag_drop;n.open_time&&clearTimeout(n.open_time),n.scroll_time&&clearTimeout(n.scroll_time);if(n.foreign===!1&&n.drag_node&&n.drag_node.size()){n.drag_help.remove();if(n.move_type){var r=t.inst[n.ref_node.parents(".tree:eq(0)").attr("id")];r&&r.moved(n.origin_tree.container.find("li.dragged"),n.ref_node,n.move_type,!1,n.origin_tree.settings.rules.drag_copy=="on"||n.origin_tree.settings.rules.drag_copy=="ctrl"&&e.ctrlKey)}n.move_type=!1,n.ref_node=!1}if(n.drag_node&&n.foreign!==!1){n.drag_help.remove();if(n.move_type){var r=t.inst[n.ref_node.parents(".tree:eq(0)").attr("id")];r&&r.settings.callback.ondrop.call(null,n.foreign.get(0),r.get_node(n.ref_node).get(0),n.move_type,r)}n.foreign=!1,n.move_type=!1,n.ref_node=!1}return t.drag_drop.marker.hide(),n.drag_help=!1,n.drag_node=!1,n.isdown=!1,n.init_x=!1,n.init_y=!1,n.moving=!1,n.appended=!1,n.origin_tree&&n.origin_tree.container.find("li.dragged").removeClass("dragged"),n.origin_tree=!1,e.preventDefault(),e.stopPropagation(),!1},t.mousemove=function(n){var r=t.drag_drop;if(r.isdown){if(!r.moving&&Math.abs(r.init_x-n.pageX)<5&&Math.abs(r.init_y-n.pageY)<5)return n.preventDefault(),n.stopPropagation(),!1;t.drag_drop.moving=!0,r.open_time&&clearTimeout(r.open_time);if(!r.appended){r.foreign!==!1&&(r.origin_tree=e.tree_focused()),r.origin_tree.container.children("ul:eq(0)").append(r.drag_help);var i=e(r.drag_help).offsetParent();i.is("html")&&(i=e("body")),r.po=i.offset(),r.po.top-=i.is("body")?0:i.scrollTop(),r.po.left-=i.is("body")?0:i.scrollLeft(),r.w=r.drag_help.width(),r.appended=!0}r.drag_help.css({left:n.pageX-r.po.left-(r.origin_tree.settings.ui.rtl?r.w:-5),top:n.pageY-r.po.top+15});if(n.target.tagName=="IMG"&&n.target.id=="marker")return!1;var s=e(n.target).parents(".tree:eq(0)");if(s.size()==0)return r.scroll_time&&clearTimeout(r.scroll_time),r.drag_help.children("IMG").size()==0&&r.drag_help.append("<img style='position:absolute; "+(r.origin_tree.settings.ui.rtl?"right":"left")+":4px; top:0px; background:white; padding:2px;' src='"+r.origin_tree.settings.ui.theme_path+"remove.png' />"),r.move_type=!1,r.ref_node=!1,t.drag_drop.marker.hide(),!1;var o=t.inst[s.attr("id")];o.off_height();if(r.foreign===!1&&r.origin_tree.container.get(0)!=o.container.get(0)&&(!r.origin_tree.settings.rules.multitree||!o.settings.rules.multitree))return r.drag_help.children("IMG").size()==0&&r.drag_help.append("<img style='position:absolute; "+(r.origin_tree.settings.ui.rtl?"right":"left")+":4px; top:0px; background:white; padding:2px;' src='"+r.origin_tree.settings.ui.theme_path+"remove.png' />"),r.move_type=!1,r.ref_node=!1,t.drag_drop.marker.hide(),!1;r.scroll_time&&clearTimeout(r.scroll_time),r.scroll_time=setTimeout(function(){o.scrollCheck(n.pageX,n.pageY)},50);var u=!1,a=s.scrollTop(),f=e(n.target);if(n.target.tagName=="A"){if(f.is("#dragged"))return!1;o.get_node(n.target).hasClass("closed")&&(r.open_time=setTimeout(function(){o.open_branch(f)},500));var l=0,c=parseInt(e.curCSS(o.container.get(0),"borderTopWidth",!0),10);c&&(l+=c);var h=parseInt(e.curCSS(o.container.get(0),"paddingTop",!0),10);h&&(l+=h);var p=f.offset(),d={x:p.left-1,y:n.pageY-p.top};s.hasClass("rtl")&&(d.x+=f.width()-8);var v=[];d.y<o.li_height/3+1?v=["before","inside","after"]:d.y>o.li_height*2/3-1?v=["after","inside","before"]:d.y<o.li_height/2?v=["inside","before","after"]:v=["inside","after","before"];var m=!1;e.each(v,function(e,t){if(o.checkMove(r.origin_tree.container.find("li.dragged"),f,t))return u=t,m=!0,!1});if(m){switch(u){case"before":d.y=p.top-2,s.hasClass("rtl")?t.drag_drop.marker.attr("src",o.settings.ui.theme_path+"marker_rtl.gif").width(40):t.drag_drop.marker.attr("src",o.settings.ui.theme_path+"marker.gif").width(40);break;case"after":d.y=p.top-2+o.li_height,s.hasClass("rtl")?t.drag_drop.marker.attr("src",o.settings.ui.theme_path+"marker_rtl.gif").width(40):t.drag_drop.marker.attr("src",o.settings.ui.theme_path+"marker.gif").width(40);break;case"inside":d.x-=2,s.hasClass("rtl")&&(d.x+=36),d.y=p.top-2+o.li_height/2,t.drag_drop.marker.attr("src",o.settings.ui.theme_path+"plus.gif").width(11)}r.move_type=u,r.ref_node=e(n.target),r.drag_help.children("IMG").remove(),t.drag_drop.marker.css({left:d.x,top:d.y}).show()}}if(n.target.tagName!="A"||!m)r.drag_help.children("IMG").size()==0&&r.drag_help.append("<img style='position:absolute; "+(r.origin_tree.settings.ui.rtl?"right":"left")+":4px; top:0px; background:white; padding:2px;' src='"+r.origin_tree.settings.ui.theme_path+"remove.png' />"),r.move_type=!1,r.ref_node=!1,t.drag_drop.marker.hide();return n.preventDefault(),n.stopPropagation(),!1}return!0}),{cntr:++t.cntr,settings:{data:{type:"predefined",method:"GET",async:!1,async_data:function(t){return{id:e(t).attr("id")||0}},url:!1,json:!1,xml:!1},selected:!1,opened:[],languages:[],path:!1,cookies:!1,ui:{dots:!0,rtl:!1,animation:0,hover_mode:!0,scroll_spd:4,theme_path:!1,theme_name:"default",context:[{id:"create",label:"Create",icon:"create.png",visible:function(e,t){return e.length!=1?!1:t.check("creatable",e)},action:function(e,t){t.create(!1,t.get_node(e))}},"separator",{id:"rename",label:"Rename",icon:"rename.png",visible:function(e,t){return e.length!=1?!1:t.check("renameable",e)},action:function(e,t){t.rename(e)}},{id:"delete",label:"Delete",icon:"remove.png",visible:function(t,n){var r=!0;return e.each(t,function(){return n.check("deletable",this)==0&&(r=!1),!1}),r},action:function(t,n){e.each(t,function(){n.remove(this)})}}]},rules:{multiple:!1,metadata:!1,type_attr:"rel",multitree:!1,createat:"bottom",use_inline:!1,clickable:"all",renameable:"all",deletable:"all",creatable:"all",draggable:"none",dragrules:"all",drag_copy:!1,droppable:[],drag_button:"left"},lang:{new_node:"New folder",loading:"Loading ..."},callback:{beforechange:function(e,t){return!0},beforeopen:function(e,t){return!0},beforeclose:function(e,t){return!0},beforemove:function(e,t,n,r){return!0},beforecreate:function(e,t,n,r){return!0},beforerename:function(e,t,n){return!0},beforedelete:function(e,t){return!0},onselect:function(e,t){},ondeselect:function(e,t){},onchange:function(e,t){},onrename:function(e,t,n,r){},onmove:function(e,t,n,r,i){},oncopy:function(e,t,n,r,i){},oncreate:function(e,t,n,r,i){},ondelete:function(e,t,n){},onopen:function(e,t){},onopen_all:function(e){},onclose:function(e,t){},error:function(e,t){},ondblclk:function(e,t){t.toggle_branch.call(t,e),t.select_branch.call(t,e)},onrgtclk:function(e,t,n){},onload:function(e){},onfocus:function(e){},ondrop:function(e,t,n,r){}}},init:function(n,r){var i=this;this.container=e(n);if(this.container.size==0){alert("Invalid container node!");return}t.inst[this.cntr]=this,this.container.attr("id")||this.container.attr("id","jstree_"+this.cntr),t.inst[this.container.attr("id")]=t.inst[this.cntr],t.focused=this.cntr,r&&r.cookies&&(this.settings.cookies=e.extend({},this.settings.cookies,r.cookies),delete r.cookies,this.settings.cookies.opts||(this.settings.cookies.opts={})),r&&r.callback&&(this.settings.callback=e.extend({},this.settings.callback,r.callback),delete r.callback),r&&r.data&&(this.settings.data=e.extend({},this.settings.data,r.data),delete r.data),r&&r.ui&&(this.settings.ui=e.extend({},this.settings.ui,r.ui),delete r.ui),r&&r.rules&&(this.settings.rules=e.extend({},this.settings.rules,r.rules),delete r.rules),r&&r.lang&&(this.settings.lang=e.extend({},this.settings.lang,r.lang),delete r.lang),this.settings=e.extend({},this.settings,r),this.settings.path==0?(this.path="",e("script").each(function(){this.src.toString().match(/tree_component.*?js$/)&&(i.path=this.src.toString().replace(/tree_component.*?js$/,""))})):this.path=this.settings.path,this.current_lang=this.settings.languages&&this.settings.languages.length?this.settings.languages[0]:!1;if(this.settings.languages&&this.settings.languages.length){this.sn=get_sheet_num("tree_component.css"),this.sn===!1&&document.styleSheets.length&&(this.sn=document.styleSheets.length);var s=!1,o=this.container.attr("id")?"#"+this.container.attr("id"):".tree";for(var u=0;u<this.settings.languages.length;u++)s=add_css(o+" ."+this.settings.languages[u],this.sn),s!==!1&&(this.settings.languages[u]==this.current_lang?s.style.display="":s.style.display="none")}if(this.settings.rules.droppable.length){for(var a in this.settings.rules.droppable)t.drag_drop.droppable.push(this.settings.rules.droppable[a]);t.drag_drop.droppable=e.unique(t.drag_drop.droppable)}this.settings.ui.theme_path===!1&&(this.settings.ui.theme_path=this.path+"/assets/admin/categories/jsTree/themes/"),this.theme=this.settings.ui.theme_path,i.settings.ui.theme_name&&(this.theme+=i.settings.ui.theme_name+"/",i.settings.ui.theme_name!="themeroller"&&!t.def_style&&(add_sheet(i.settings.ui.theme_path+"default/style.css"),t.def_style=!0),add_sheet(i.theme+"style.css")),this.container.addClass("tree"),this.settings.ui.theme_name=="themeroller"&&this.container.addClass("ui-widget ui-widget-content"),this.settings.ui.rtl&&this.container.addClass("rtl"),this.settings.rules.multiple&&(this.selected_arr=[]),this.offset=!1,this.settings.ui.dots==0&&this.container.addClass("no_dots"),this.context_menu(),this.hovered=!1,this.locked=!1;if(this.settings.rules.draggable!="none"&&t.drag_drop.marker===!1){var i=this;t.drag_drop.marker=e("<img>").attr({id:"marker",src:i.settings.ui.theme_path+"marker.gif"}).css({height:"5px",width:"40px",display:"block",position:"absolute",left:"30px",top:"30px",zIndex:"1000"}).hide().appendTo("body")}this.refresh(),this.attachEvents(),this.focus()},off_height:function(){if(this.offset===!1){this.container.css({position:"relative"}),this.offset=this.container.offset();var t=0;t=parseInt(e.curCSS(this.container.get(0),"paddingTop",!0),10),t&&(this.offset.top+=t),t=parseInt(e.curCSS(this.container.get(0),"borderTopWidth",!0),10),t&&(this.offset.top+=t),this.container.css({position:""})}if(!this.li_height){var t=this.container.find("ul li.closed, ul li.leaf").eq(0);this.li_height=t.height(),t.children("ul:eq(0)").size()&&(this.li_height-=t.children("ul:eq(0)").height()),this.li_height||(this.li_height=18)}},context_menu:function(){this.context=!1;if(this.settings.ui.context!=0){var t='<div class="tree-default-context tree-'+this.settings.ui.theme_name+'-context">';for(var n in this.settings.ui.context){if(this.settings.ui.context[n]=="separator"){t+="<span class='separator'>&nbsp;</span>";continue}var r="";this.settings.ui.context[n].icon&&(r="background-image:url('"+(this.settings.ui.context[n].icon.indexOf("/")==-1?this.theme+this.settings.ui.context[n].icon:this.settings.ui.context[n].icon)+"');"),t+='<a rel="'+this.settings.ui.context[n].id+'" href="#" style="'+r+'">'+this.settings.ui.context[n].label+"</a>"}t+="</div>",this.context=e(t),this.context.hide(),this.context.append=!1}},refresh:function(t){if(this.locked)return this.error("LOCKED");var n=this;this.opened=Array();if(this.settings.cookies&&e.cookie(this.settings.cookies.prefix+"_open")){var r=e.cookie(this.settings.cookies.prefix+"_open"),i=r.split(",");e.each(i,function(){n.opened.push("#"+this.replace(/^#/,""))}),this.settings.opened=!1}else this.settings.opened!=0?(e.each(this.settings.opened,function(e,t){n.opened.push("#"+this.replace(/^#/,""))}),this.settings.opened=!1):this.container.find("li.open").each(function(e){n.opened.push("#"+this.id)});if(this.selected)this.settings.selected=Array(),this.selected_arr?e.each(this.selected_arr,function(){this.attr("id")&&n.settings.selected.push("#"+this.attr("id"))}):this.selected.attr("id")&&this.settings.selected.push("#"+this.selected.attr("id"));else if(this.settings.cookies&&e.cookie(this.settings.cookies.prefix+"_selected")){this.settings.selected=Array();var r=e.cookie(this.settings.cookies.prefix+"_selected"),i=r.split(",");e.each(i,function(){n.settings.selected.push("#"+this.replace(/^#/,""))})}else if(this.settings.selected!==!1){var i=Array();(typeof this.settings.selected).toLowerCase()=="object"?e.each(this.settings.selected,function(){this.replace(/^#/,"").length>0&&i.push("#"+this.replace(/^#/,""))}):this.settings.selected.replace(/^#/,"").length>0&&i.push("#"+this.settings.selected.replace(/^#/,"")),this.settings.selected=i}if(t&&this.settings.data.async)return this.opened=Array(),t=this.get_node(t),t.find("li.open").each(function(e){n.opened.push("#"+this.id)}),t.hasClass("open")&&this.close_branch(t,!0),t.hasClass("leaf")&&t.removeClass("leaf"),t.children("ul:eq(0)").html(""),this.open_branch(t,!0,function(){n.reselect.apply(n)});var s="tree-default";this.settings.ui.theme_name!="default"&&(s+=" tree-"+n.settings.ui.theme_name),this.settings.ui.theme_name=="themeroller"&&(s="tree-themeroller");if(this.settings.data.type=="xml_flat"||this.settings.data.type=="xml_nested"){this.scrtop=this.container.get(0).scrollTop;var o=this.settings.data.type=="xml_flat"?"flat.xsl":"nested.xsl";this.settings.data.xml?this.container.getTransform(this.path+o,this.settings.data.xml,{params:{theme_name:s,theme_path:n.theme},meth:n.settings.data.method,dat:n.settings.data.async_data.apply(n,[t]),callback:function(){n.context_menu.apply(n),n.reselect.apply(n)}}):this.container.getTransform(this.path+o,this.settings.data.url,{params:{theme_name:s,theme_path:n.theme},meth:n.settings.data.method,dat:n.settings.data.async_data.apply(n,[t]),callback:function(){n.context_menu.apply(n),n.reselect.apply(n)}});return}if(this.settings.data.type=="json")if(this.settings.data.json){var r="";if(this.settings.data.json.length)for(var u=0;u<this.settings.data.json.length;u++)r+=this.parseJSON(this.settings.data.json[u]);else r=this.parseJSON(this.settings.data.json);this.container.html("<ul class='"+s+"'>"+r+"</ul>"),this.container.find("li:last-child").addClass("last").end().find("li:has(ul)").not(".open").addClass("closed"),this.container.find("li").not(".open").not(".closed").addClass("leaf"),this.context_menu(),this.reselect()}else{var n=this;e.ajax({type:this.settings.data.method,url:this.settings.data.url,data:this.settings.data.async_data(!1),dataType:"json",success:function(e){var t="";if(e.length)for(var r=0;r<e.length;r++)t+=n.parseJSON(e[r]);else t=n.parseJSON(e);n.container.html("<ul class='"+s+"'>"+t+"</ul>"),n.container.find("li:last-child").addClass("last").end().find("li:has(ul)").not(".open").addClass("closed"),n.container.find("li").not(".open").not(".closed").addClass("leaf"),n.context_menu.apply(n),n.reselect.apply(n)},error:function(e,t,r){n.error(r+" "+t)}})}else this.container.children("ul:eq(0)").attr("class",s),this.container.find("li:last-child").addClass("last").end().find("li:has(ul)").not(".open").addClass("closed"),this.container.find("li").not(".open").not(".closed").addClass("leaf"),this.reselect()},parseJSON:function(e){if(!e||!e.data)return"";var t="";t+="<li ";var n=!1;if(e.attributes)for(var r in e.attributes)if(r=="class"){t+=" class='"+e.attributes[r]+" ";if(e.state=="closed"||e.state=="open")t+=" "+e.state+" ";t+="' ",n=!0}else t+=" "+r+"='"+e.attributes[r]+"' ";!n&&(e.state=="closed"||e.state=="open")&&(t+=" class='"+e.state+"' "),t+=">";if(this.settings.languages.length)for(var r=0;r<this.settings.languages.length;r++){var i={};i.href="#",i.style="",i["class"]=this.settings.languages[r];if(e.data[this.settings.languages[r]]&&(typeof e.data[this.settings.languages[r]].attributes).toLowerCase()!="undefined")for(var s in e.data[this.settings.languages[r]].attributes)s=="style"||s=="class"?i[s]+=" "+e.data[this.settings.languages[r]].attributes[s]:i[s]=e.data[this.settings.languages[r]].attributes[s];if(e.data[this.settings.languages[r]]&&e.data[this.settings.languages[r]].icon&&this.settings.theme_name!="themeroller"){var o=e.data[this.settings.languages[r]].icon.indexOf("/")==-1?this.theme+e.data[this.settings.languages[r]].icon:e.data[this.settings.languages[r]].icon;i.style+=" ; background-image:url('"+o+"'); "}t+="<a";for(var s in i)t+=" "+s+'="'+i[s]+'" ';t+=">",e.data[this.settings.languages[r]]&&e.data[this.settings.languages[r]].icon&&this.settings.theme_name=="themeroller"&&(t+="<ins class='ui-icon "+e.data[this.settings.languages[r]].icon+"'>&nbsp;</ins>"),t+=((typeof e.data[this.settings.languages[r]].title).toLowerCase()!="undefined"?e.data[this.settings.languages[r]].title:e.data[this.settings.languages[r]])+"</a>"}else{var i={};i.href="#",i.style="",i["class"]="";if((typeof e.data.attributes).toLowerCase()!="undefined")for(var r in e.data.attributes)r=="style"||r=="class"?i[r]+=" "+e.data.attributes[r]:i[r]=e.data.attributes[r];if(e.data.icon&&this.settings.ui.theme_name!="themeroller"){var o=e.data.icon.indexOf("/")==-1?this.theme+e.data.icon:e.data.icon;i.style+=" ; background-image:url('"+o+"');"}t+="<a";for(var r in i)t+=" "+r+'="'+i[r]+'" ';t+=">",e.data.icon&&this.settings.ui.theme_name=="themeroller"&&(t+="<ins class='ui-icon "+e.data.icon+"'>&nbsp;</ins>"),t+=((typeof e.data.title).toLowerCase()!="undefined"?e.data.title:e.data)+"</a>"}if(e.children&&e.children.length){t+="<ul>";for(var r=0;r<e.children.length;r++)t+=this.parseJSON(e.children[r]);t+="</ul>"}return t+="</li>",t},getJSON:function(t,n,r,i){var s=this;!t||e(t).size()==0?t=this.container.children("ul").children("li"):t=e(t);if(t.size()>1){var o=[];return t.each(function(){o.push(s.getJSON(this,n,r,i))}),o}n||(n=["id","rel","class"]),r||(r=[]);var u={attributes:{},data:!1};for(var a in n){var f=n[a]=="class"?t.attr(n[a]).replace("last","").replace("leaf","").replace("closed","").replace("open",""):t.attr(n[a]);typeof f!="undefined"&&f.replace(" ","").length>0&&(u.attributes[n[a]]=f),delete f}if(this.settings.languages.length){u.data={};for(var a in this.settings.languages){var l=t.children("a."+this.settings.languages[a]);if(i||r.length||l.get(0).style.backgroundImage.toString().length){u.data[this.settings.languages[a]]={},u.data[this.settings.languages[a]].title=l.text(),l.get(0).style.backgroundImage.length&&(u.data[this.settings.languages[a]].icon=l.get(0).style.backgroundImage.replace("url(","").replace(")",""));if(this.settings.ui.theme_name=="themeroller"&&l.children("ins").size()){var c=l.children("ins").attr("class"),h=!1;e.each(c.split(" "),function(e,t){if(t.indexOf("ui-icon-")==0)return h=t,!1}),h&&(u.data[this.settings.languages[a]].icon=h)}if(r.length){u.data[this.settings.languages[a]].attributes={};for(var p in r){var f=l.attr(r[p]);typeof f!="undefined"&&f.replace(" ","").length>0&&(u.data[this.settings.languages[a]].attributes[r[p]]=f),delete f}}}else u.data[this.settings.languages[a]]=l.text()}}else{var l=t.children("a");if(i||r.length||l.get(0).style.backgroundImage.toString().length){u.data={},u.data.title=l.text(),l.get(0).style.backgroundImage.length&&(u.data.icon=l.get(0).style.backgroundImage.replace("url(","").replace(")",""));if(this.settings.ui.theme_name=="themeroller"&&l.children("ins").size()){var c=l.children("ins").attr("class"),h=!1;e.each(c.split(" "),function(e,t){if(t.indexOf("ui-icon-")==0)return h=t,!1}),h&&(u.data[this.settings.languages[a]].icon=h)}if(r.length){u.data.attributes={};for(var p in r){var f=l.attr(r[p]);typeof f!="undefined"&&f.replace(" ","").length>0&&(u.data.attributes[r[p]]=f),delete f}}}else u.data=l.text()}return t.children("ul").size()>0&&(u.children=[],t.children("ul").children("li").each(function(){u.children.push(s.getJSON(this,n,r,i))})),u},getXML:function(t,n,r,i,s){var o=this;t!="flat"&&(t="nested"),!n||e(n).size()==0?n=this.container.children("ul").children("li"):n=e(n);if(n.size()>1){var u="<root>";return n.each(function(){u+=o.getXML(t,this,r,i,!0)}),u+="</root>",u}r||(r=["id","rel","class"]),i||(i=[]);var u="";s||(u="<root>"),u+="<item ";if(t=="flat"){var a=n.parents("li:eq(0)").size()?n.parents("li:eq(0)").attr("id"):0;u+=' parent_id="'+a+'" ',delete a}for(var f in r){var l=r[f]=="class"?n.attr(r[f]).replace("last","").replace("leaf","").replace("closed","").replace("open",""):n.attr(r[f]);typeof l!="undefined"&&l.replace(" ","").length>0&&(u+=" "+r[f]+'="'+l+'" '),delete l}u+=">",u+="<content>";if(this.settings.languages.length)for(var f in this.settings.languages){var c=n.children("a."+this.settings.languages[f]);u+="<name ";if(i.length||c.get(0).style.backgroundImage.toString().length||this.settings.ui.theme_name=="themeroller"){c.get(0).style.backgroundImage.length&&(u+=' icon="'+c.get(0).style.backgroundImage.replace("url(","").replace(")","")+'" ');if(this.settings.ui.theme_name=="themeroller"&&c.children("ins").size()){var h=c.children("ins").attr("class"),p=!1;e.each(h.split(" "),function(e,t){if(t.indexOf("ui-icon-")==0)return p=t,!1}),p&&(u+=' icon="'+p+'" ')}if(i.length)for(var d in i){var l=c.attr(i[d]);typeof l!="undefined"&&l.replace(" ","").length>0&&(u+=" "+i[d]+'="'+l+'" '),delete l}}u+="><![CDATA["+c.text()+"]]></name>"}else{var c=n.children("a");u+="<name ";if(i.length||c.get(0).style.backgroundImage.toString().length||this.settings.ui.theme_name=="themeroller"){c.get(0).style.backgroundImage.length&&(u+=' icon="'+c.get(0).style.backgroundImage.replace("url(","").replace(")","")+'" ');if(this.settings.ui.theme_name=="themeroller"&&c.children("ins").size()){var h=c.children("ins").attr("class"),p=!1;e.each(h.split(" "),function(e,t){if(t.indexOf("ui-icon-")==0)return p=t,!1}),p&&(u+=' icon="'+p+'" ')}if(i.length)for(var d in i){var l=c.attr(i[d]);typeof l!="undefined"&&l.replace(" ","").length>0&&(u+=" "+i[d]+'="'+l+'" '),delete l}}u+="><![CDATA["+c.text()+"]]></name>"}return u+="</content>",t=="flat"&&(u+="</item>"),n.children("ul").size()>0&&n.children("ul").children("li").each(function(){u+=o.getXML(t,this,r,i,!0)}),t=="nested"&&(u+="</item>"),s||(u+="</root>"),u},focus:function(){if(this.locked)return!1;t.focused!=this.cntr&&(t.focused=this.cntr,this.settings.callback.onfocus.call(null,this))},show_context:function(t,n,r){var i=this.context.show().offsetParent();i.is("html")&&(i=e("body")),i=i.offset(),this.context.css({left:n-i.left-(this.settings.ui.rtl?e(this.context).width():0),top:r-i.top+(e.browser.opera?this.container.scrollTop():0)+0})},hide_context:function(){this.context.remove&&this.context.apply_to&&this.context.apply_to.children("a").removeClass("clicked"),this.context.apply_to=!1,this.context.hide()},attachEvents:function(){var n=this;this.container.bind("mousedown",function(e){if(t.drag_drop.isdown)return t.drag_drop.move_type=!1,e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!1}).bind("mouseup",function(e){setTimeout(function(){n.focus.apply(n)},5)}).bind("click",function(e){return!0}),e("#"+this.container.attr("id")+" li").live("click",function(t){return t.target.tagName!="LI"?!0:(n.off_height(),t.pageY-e(t.target).offset().top>n.li_height?!0:(n.toggle_branch.apply(n,[t.target]),t.stopPropagation(),!1))}),e("#"+this.container.attr("id")+" li a").live("click",function(e){return e.which&&e.which==3?!0:n.locked?(e.preventDefault(),e.target.blur(),n.error("LOCKED")):(n.select_branch.apply(n,[e.target,e.ctrlKey||n.settings.rules.multiple=="on"]),n.inp&&n.inp.blur(),e.preventDefault(),e.target.blur(),!1)}).live("dblclick",function(e){if(n.locked)return e.preventDefault(),e.stopPropagation(),e.target.blur(),n.error("LOCKED");n.settings.callback.ondblclk.call(null,n.get_node(e.target).get(0),n),e.preventDefault(),e.stopPropagation(),e.target.blur()}).live("contextmenu",function(t){if(n.locked)return t.target.blur(),n.error("LOCKED");var r=n.settings.callback.onrgtclk.call(null,n.get_node(t.target).get(0),n,t);if(n.context){if(n.context.append==0){e("body").append(n.context),n.context.append=!0;for(var i in n.settings.ui.context){if(n.settings.ui.context[i]=="separator")continue;(function(){var t=n.settings.ui.context[i].action;n.context.children("[rel="+n.settings.ui.context[i].id+"]").bind("click",function(r){return e(this).hasClass("disabled")||(t.call(null,n.context.apply_to||null,n),n.hide_context()),r.stopPropagation(),r.preventDefault(),!1}).bind("mouseup",function(t){this.blur();if(e(this).hasClass("disabled"))return t.stopPropagation(),t.preventDefault(),!1}).bind("mousedown",function(e){e.stopPropagation(),e.preventDefault()})})()}}var s=n.get_node(t.target);n.inp&&n.inp.blur();if(s){s.children("a:eq(0)").hasClass("clicked")?(n.context.remove=!1,n.context.apply_to=n.selected_arr||n.selected):(n.context.apply_to=s,n.context.remove=!0,n.context.apply_to.children("a").addClass("clicked"),t.target.blur()),n.context.children("a").removeClass("disabled").show();var o=!1;for(var i in n.settings.ui.context){if(n.settings.ui.context[i]=="separator")continue;var u=n.settings.ui.context[i].visible.call(null,n.context.apply_to,n);u===!1&&n.context.children("[rel="+n.settings.ui.context[i].id+"]").addClass("disabled"),u===-1?n.context.children("[rel="+n.settings.ui.context[i].id+"]").hide():o=!0}return o==1&&n.show_context(s,t.pageX,t.pageY),t.preventDefault(),t.stopPropagation(),!1}}return r}).live("mouseover",function(e){if(n.locked)return e.preventDefault(),e.stopPropagation(),n.error("LOCKED");(n.settings.ui.hover_mode||n.settings.ui.theme_name=="themeroller")&&n.hovered!==!1&&e.target.tagName=="A"&&(n.hovered.children("a").removeClass("hover ui-state-hover"),n.hovered=!1),n.settings.ui.theme_name=="themeroller"&&n.hover_branch.apply(n,[e.target])}),n.settings.ui.theme_name=="themeroller"&&e("#"+this.container.attr("id")+" li a").live("mouseout",function(e){n.hovered&&n.hovered.children("a").removeClass("hover ui-state-hover")}),this.settings.rules.draggable!="none"&&(e("#"+this.container.attr("id")+" li a").live("mousedown",function(r){if(n.settings.rules.drag_button=="left"&&r.which&&r.which!=1)return!1;if(n.settings.rules.drag_button=="right"&&r.which&&r.which!=3)return!1;n.focus.apply(n);if(n.locked)return n.error("LOCKED");var i=n.get_node(r.target);if(n.settings.rules.multiple!=0&&n.selected_arr.length>1&&i.children("a:eq(0)").hasClass("clicked")){var s=0;for(var o in n.selected_arr)n.check("draggable",n.selected_arr[o])&&(n.selected_arr[o].addClass("dragged"),t.drag_drop.origin_tree=n,s++);s>0&&(n.check("draggable",i)?t.drag_drop.drag_node=i:t.drag_drop.drag_node=n.container.find("li.dragged:eq(0)"),t.drag_drop.isdown=!0,t.drag_drop.drag_help=e(t.drag_drop.drag_node.get(0).cloneNode(!0)),t.drag_drop.drag_help.attr("id","dragged"),t.drag_drop.drag_help.children("a").html("Multiple selection").end().children("ul").remove())}else n.check("draggable",i)&&(t.drag_drop.drag_node=i,t.drag_drop.drag_help=e(i.get(0).cloneNode(!0)),t.drag_drop.drag_help.attr("id","dragged"),t.drag_drop.isdown=!0,t.drag_drop.foreign=!1,t.drag_drop.origin_tree=n,i.addClass("dragged"));return t.drag_drop.init_x=r.pageX,t.drag_drop.init_y=r.pageY,i.blur(),r.preventDefault(),r.stopPropagation(),!1}),e(document).bind("mousedown",t.mousedown).bind("mouseup",t.mouseup).bind("mousemove",t.mousemove)),n.context&&e(document).bind("mousedown",function(){n.hide_context()})},checkMove:function(n,r,i){if(this.locked)return this.error("LOCKED");var s=this;if(r.parents("li.dragged").size()>0||r.is(".dragged"))return this.error("MOVE: NODE OVER SELF");if(n.size()==1){var o=n.eq(0);if(t.drag_drop.foreign){if(this.settings.rules.droppable.length==0)return!1;if(!o.is("."+this.settings.rules.droppable.join(", .")))return!1;var u=!1;for(var a in this.settings.rules.droppable)if(o.is("."+this.settings.rules.droppable[a])){this.settings.rules.metadata?(e.metadata.setType("attr",this.settings.rules.metadata),o.attr(this.settings.rules.metadata,"type: '"+this.settings.rules.droppable[a]+"'")):o.attr(this.settings.rules.type_attr,this.settings.rules.droppable[a]),u=!0;break}if(!u)return!1}if(!this.check("dragrules",[o,i,r.parents("li:eq(0)")]))return this.error("MOVE: AGAINST DRAG RULES")}else{var u=!0;n.each(function(t){if(u==0)return!1;var n=r,o=i;s.check.apply(s,["dragrules",[e(this),o,n]])||(u=!1)});if(u==0)return this.error("MOVE: AGAINST DRAG RULES")}if(this.settings.rules.use_inline&&this.settings.rules.metadata){var f=!1;i=="inside"?f=r.parents("li:eq(0)"):f=r.parents("li:eq(1)");if(f.size()){if(typeof f.metadata()["valid_children"]!="undefined"){var l=f.metadata().valid_children,u=!0;n.each(function(t){if(u==0)return!1;e.inArray(s.get_type(this),l)==-1&&(u=!1)});if(u==0)return this.error("MOVE: NOT A VALID CHILD")}if(typeof f.metadata()["max_children"]!="undefined"&&f.children("ul:eq(0)").children("li").not(".dragged").size()+n.size()>f.metadata().max_children)return this.error("MOVE: MAX CHILDREN REACHED");var c=0;n.each(function(t){var n=1,r=e(this);while(n<100){r=r.children("ul").children("li");if(r.size()==0)break;n++}c=Math.max(n,c)});var u=!0;(typeof e(f).metadata().max_depth).toLowerCase()!="undefined"&&e(f).metadata().max_depth<c?u=!1:f.parents("li").each(function(t){if(u==0)return!1;(typeof e(this).metadata().max_depth).toLowerCase()!="undefined"&&t+c>=e(this).metadata().max_depth&&(u=!1)});if(u==0)return this.error("MOVE: MAX_DEPTH REACHED")}}return!0},reselect:function(){var t=this;if(this.opened&&this.opened.length){var n=!1;for(var r=0;r<this.opened.length;r++)if(this.settings.data.async){if(this.get_node(this.opened[r]).size()>0){n=!0;var i=this.opened[r];delete this.opened[r],this.open_branch(i,!0,function(){t.reselect.apply(t)})}}else this.open_branch(this.opened[r],!0);if(this.settings.data.async&&n)return;delete this.opened}this.scrtop&&(this.container.scrollTop(t.scrtop),delete this.scrtop),this.settings.selected!==!1&&(e.each(this.settings.selected,function(n){t.select_branch(e(t.settings.selected[n],t.container),t.settings.rules.multiple!==!1&&n>0)}),this.settings.selected=!1),this.settings.ui.theme_name=="themeroller"&&this.container.find("a").addClass("ui-state-default"),this.settings.callback.onload.call(null,t)},get_node:function(t){var t=e(t);return t.is("li")?t:t.parents("li:eq(0)")},get_type:function(t){t=t?this.get_node(t):this.selected;if(!t)return;if(this.settings.rules.metadata){e.metadata.setType("attr",this.settings.rules.metadata);var n=t.metadata().type;if(n)return n}return t.attr(this.settings.rules.type_attr)},scrollCheck:function(e,n){var r=this,i=r.container,s=r.container.offset(),o=i.scrollTop(),u=i.scrollLeft(),a=i.get(0).scrollWidth>i.width()?40:20;n-s.top<20&&i.scrollTop(Math.max(o-r.settings.ui.scroll_spd,0)),i.height()-(n-s.top)<a&&i.scrollTop(o+r.settings.ui.scroll_spd),e-s.left<20&&i.scrollLeft(Math.max(u-r.settings.ui.scroll_spd,0)),i.width()-(e-s.left)<40&&i.scrollLeft(u+r.settings.ui.scroll_spd);if(i.scrollLeft()!=u||i.scrollTop()!=o)r.moveType=!1,r.moveRef=!1,t.drag_drop.marker.hide();t.drag_drop.scroll_time=setTimeout(function(){r.scrollCheck(e,n)},50)},check:function(t,n){if(this.locked)return this.error("LOCKED");if(t!="dragrules"&&this.settings.rules.use_inline&&this.settings.rules.metadata){e.metadata.setType("attr",this.settings.rules.metadata);if(typeof this.get_node(n).metadata()[t]!="undefined")return this.get_node(n).metadata()[t]}if(!this.settings.rules[t])return!1;if(this.settings.rules[t]=="none")return!1;if(this.settings.rules[t]=="all")return!0;if(t=="dragrules"){var r=new Array;r[0]=this.get_type(n[0]),r[1]=n[1],r[2]=this.get_type(n[2]);for(var i=0;i<this.settings.rules.dragrules.length;i++){var s=this.settings.rules.dragrules[i],o=s.indexOf("!")===0?!1:!0;o||(s=s.replace("!",""));var u=s.split(" ");for(var a=0;a<3;a++)if(u[a]==r[a]||u[a]=="*")u[a]=!0;if(u[0]===!0&&u[1]===!0&&u[2]===!0)return o}return!1}return e.inArray(this.get_type(n),this.settings.rules[t])!=-1?!0:!1},hover_branch:function(e){if(this.locked)return this.error("LOCKED");if(this.settings.ui.hover_mode==0&&this.settings.theme_name!="themeroller")return this.select_branch(e);var t=this,e=t.get_node(e);if(!e.size())return this.error("HOVER: NOT A VALID NODE");if(!t.check("clickable",e))return this.error("SELECT: NODE NOT SELECTABLE");this.hovered&&this.hovered.children("A").removeClass("hover ui-state-hover"),this.hovered=e,this.hovered.children("a").removeClass
("hover ui-state-hover").addClass(this.settings.ui.theme_name=="themeroller"?"hover ui-state-hover":"hover");var n=this.hovered.offset().top,r=this.container.offset().top,i=r+this.container.height(),s=this.container.get(0).scrollWidth>this.container.width()?40:20;n+5<r&&this.container.scrollTop(this.container.scrollTop()-(r-n+5)),n+s>i&&this.container.scrollTop(this.container.scrollTop()+(n+s-i))},select_branch:function(e,t){if(this.locked)return this.error("LOCKED");!e&&this.hovered!==!1&&(e=this.hovered);var n=this;e=n.get_node(e);if(!e.size())return this.error("SELECT: NOT A VALID NODE");e.children("a").removeClass("hover ui-state-hover");if(!n.check("clickable",e))return this.error("SELECT: NODE NOT SELECTABLE");if(n.settings.callback.beforechange.call(null,e.get(0),n)===!1)return this.error("SELECT: STOPPED BY USER");if(this.settings.rules.multiple!=0&&t&&e.children("a.clicked").size()>0)return this.deselect_branch(e);this.settings.rules.multiple!=0&&t&&this.selected_arr.push(e);if(this.settings.rules.multiple!=0&&!t){for(var r in this.selected_arr)this.selected_arr[r].children("A").removeClass("clicked ui-state-active"),this.settings.callback.ondeselect.call(null,this.selected_arr[r].get(0),n);this.selected_arr=[],this.selected_arr.push(e),this.selected&&this.selected.children("A").hasClass("clicked")&&(this.selected.children("A").removeClass("clicked ui-state-active"),this.settings.callback.ondeselect.call(null,this.selected.get(0),n))}this.settings.rules.multiple||this.selected&&(this.selected.children("A").removeClass("clicked ui-state-active"),this.settings.callback.ondeselect.call(null,this.selected.get(0),n)),this.selected=e,(this.settings.ui.hover_mode||this.settings.ui.theme_name=="themeroller")&&this.hovered!==!1&&(this.hovered.children("A").removeClass("hover ui-state-hover"),this.hovered=e),this.selected.children("a").removeClass("clicked ui-state-active").addClass(this.settings.ui.theme_name=="themeroller"?"clicked ui-state-active":"clicked").end().parents("li.closed").each(function(){n.open_branch(this,!0)});var i=this.selected.offset().top,s=this.container.offset().top,o=s+this.container.height(),u=this.container.get(0).scrollWidth>this.container.width()?40:20;i+5<s&&this.container.scrollTop(this.container.scrollTop()-(s-i+5)),i+u>o&&this.container.scrollTop(this.container.scrollTop()+(i+u-o)),this.set_cookie("selected"),this.settings.callback.onselect.call(null,this.selected.get(0),n),this.settings.callback.onchange.call(null,this.selected.get(0),n)},deselect_branch:function(t){if(this.locked)return this.error("LOCKED");var n=this,t=this.get_node(t);t.children("a").removeClass("clicked ui-state-active"),this.settings.callback.ondeselect.call(null,t.get(0),n),this.settings.rules.multiple!=0&&this.selected_arr.length>1?(this.selected_arr=[],this.container.find("a.clicked").filter(":first-child").parent().each(function(){n.selected_arr.push(e(this))}),t.get(0)==this.selected.get(0)&&(this.selected=this.selected_arr[0],this.set_cookie("selected"))):(this.settings.rules.multiple!=0&&(this.selected_arr=[]),this.selected=!1,this.set_cookie("selected")),this.selected?this.settings.callback.onchange.call(null,this.selected.get(0),n):this.settings.callback.onchange.call(null,!1,n)},toggle_branch:function(e){if(this.locked)return this.error("LOCKED");var e=this.get_node(e);if(e.hasClass("closed"))return this.open_branch(e);if(e.hasClass("open"))return this.close_branch(e)},open_branch:function(t,n,r){if(this.locked)return this.error("LOCKED");var t=this.get_node(t);if(!t.size())return this.error("OPEN: NO SUCH NODE");if(t.hasClass("leaf"))return this.error("OPEN: OPENING LEAF NODE");if(this.settings.data.async&&t.find("li").size()==0){if(this.settings.callback.beforeopen.call(null,t.get(0),this)===!1)return this.error("OPEN: STOPPED BY USER");var i=this;t.children("ul:eq(0)").remove().end().append("<ul><li class='last'><a class='loading' href='#'>"+(i.settings.lang.loading||"Loading ...")+"</a></li></ul>"),t.removeClass("closed").addClass("open");if(this.settings.data.type=="xml_flat"||this.settings.data.type=="xml_nested"){var s=this.settings.data.type=="xml_flat"?"flat.xsl":"nested.xsl";t.children("ul:eq(0)").getTransform(this.path+s,this.settings.data.url,{params:{theme_path:i.theme},meth:this.settings.data.method,dat:this.settings.data.async_data(t),repl:!0,callback:function(e,n){if(e.length<15){t.removeClass("closed").removeClass("open").addClass("leaf").children("ul").remove(),r&&r.call();return}i.open_branch.apply(i,[t]),r&&r.call()}})}else e.ajax({type:this.settings.data.method,url:this.settings.data.url,data:this.settings.data.async_data(t),dataType:"json",success:function(e,n){if(!e||e.length==0){t.removeClass("closed").removeClass("open").addClass("leaf").children("ul").remove(),r&&r.call();return}var s="";if(e.length)for(var o=0;o<e.length;o++)s+=i.parseJSON(e[o]);else s=i.parseJSON(e);s.length>0?(t.children("ul:eq(0)").replaceWith("<ul>"+s+"</ul>"),t.find("li:last-child").addClass("last").end().find("li:has(ul)").not(".open").addClass("closed"),t.find("li").not(".open").not(".closed").addClass("leaf"),i.open_branch.apply(i,[t])):t.removeClass("closed").removeClass("open").addClass("leaf").children("ul").remove(),r&&r.call()}});return!0}return!this.settings.data.async&&this.settings.callback.beforeopen.call(null,t.get(0),this)===!1?this.error("OPEN: STOPPED BY USER"):(this.settings.ui.theme_name=="themeroller"&&t.find("a").not(".ui-state-default").addClass("ui-state-default"),parseInt(this.settings.ui.animation)>0&&!n?(t.children("ul:eq(0)").css("display","none"),t.removeClass("closed").addClass("open"),t.children("ul:eq(0)").slideDown(parseInt(this.settings.ui.animation),function(){e(this).css("display",""),r&&r.call()})):(t.removeClass("closed").addClass("open"),r&&r.call()),this.set_cookie("open"),this.settings.callback.onopen.call(null,t.get(0),this),!0)},close_branch:function(t,n){if(this.locked)return this.error("LOCKED");var r=this,t=this.get_node(t);if(!t.size())return this.error("CLOSE: NO SUCH NODE");if(r.settings.callback.beforeclose.call(null,t.get(0),r)===!1)return this.error("CLOSE: STOPPED BY USER");parseInt(this.settings.ui.animation)>0&&!n&&t.children("ul:eq(0)").size()==1?t.children("ul:eq(0)").slideUp(parseInt(this.settings.ui.animation),function(){t.hasClass("open")&&t.removeClass("open").addClass("closed"),r.set_cookie("open"),e(this).css("display","")}):(t.hasClass("open")&&t.removeClass("open").addClass("closed"),this.set_cookie("open")),this.selected&&t.children("ul:eq(0)").find("a.clicked").size()>0&&(t.find("li:has(a.clicked)").each(function(){r.deselect_branch(this)}),t.children("a.clicked").size()==0&&this.select_branch(t,this.settings.rules.multiple!=0&&this.selected_arr.length>0)),this.settings.callback.onclose.call(null,t.get(0),this)},open_all:function(t,n){if(this.locked)return this.error("LOCKED");var r=this;t=t?e(t):this.container;var i=t.find("li.closed").size();n?this.cl_count--:this.cl_count=0,i>0?(this.cl_count+=i,t.find("li.closed").each(function(){var e=this;r.open_branch.apply(r,[this,!0,function(){r.open_all.apply(r,[e,!0])}])})):this.cl_count==0&&this.settings.callback.onopen_all.call(null,this)},close_all:function(){if(this.locked)return this.error("LOCKED");var e=this;this.container.find("li.open").each(function(){e.close_branch(this,!0)})},show_lang:function(e){if(this.locked)return this.error("LOCKED");if(this.settings.languages[e]==this.current_lang)return!0;var t=!1,n=this.container.attr("id")?"#"+this.container.attr("id"):".tree";return t=get_css(n+" ."+this.current_lang,this.sn),t!==!1&&(t.style.display="none"),t=get_css(n+" ."+this.settings.languages[e],this.sn),t!==!1&&(t.style.display=""),this.current_lang=this.settings.languages[e],!0},cycle_lang:function(){if(this.locked)return this.error("LOCKED");var t=e.inArray(this.current_lang,this.settings.languages);t++,t>this.settings.languages.length-1&&(t=0),this.show_lang(t)},create:function(t,n,r){if(this.locked)return this.error("LOCKED");var i=!1;n==-1?(i=!0,n=this.container):n=n?this.get_node(n):this.selected;if(!i&&(!n||!n.size()))return this.error("CREATE: NO NODE SELECTED");var s=n;r=="before"&&(r=n.parent().children().index(n),n=n.parents("li:eq(0)")),r=="after"&&(r=n.parent().children().index(n)+1,n=n.parents("li:eq(0)")),!i&&n.size()==0&&(i=!0,n=this.container);if(!i){if(!this.check("creatable",n))return this.error("CREATE: CANNOT CREATE IN NODE");if(n.hasClass("closed")){if(this.settings.data.async&&n.children("ul").size()==0){var o=this;return this.open_branch(n,!0,function(){o.create.apply(o,[t,n,r])})}this.open_branch(n,!0)}}var u=!1;t||(t={}),t.attributes||(t.attributes={}),this.settings.rules.metadata?t.attributes[this.settings.rules.metadata]||(t.attributes[this.settings.rules.metadata]='{ "type" : "'+(this.get_type(s)||"")+'" }'):t.attributes[this.settings.rules.type_attr]||(t.attributes[this.settings.rules.type_attr]=this.get_type(s)||"");if(this.settings.languages.length){t.data||(t.data={},u=!0);for(var a=0;a<this.settings.languages.length;a++)t.data[this.settings.languages[a]]||(t.data[this.settings.languages[a]]=(typeof this.settings.lang.new_node).toLowerCase()!="string"&&this.settings.lang.new_node[a]?this.settings.lang.new_node[a]:this.settings.lang.new_node)}else t.data||(t.data=this.settings.lang.new_node,u=!0);var f=e(this.parseJSON(t));f.addClass("leaf");if(!i&&this.settings.rules.use_inline&&this.settings.rules.metadata){var l=this.get_type(f)||"";e.metadata.setType("attr",this.settings.rules.metadata);if(typeof n.metadata()["valid_children"]!="undefined"&&e.inArray(l,n.metadata()["valid_children"])==-1)return this.error("CREATE: NODE NOT A VALID CHILD");if(typeof n.metadata()["max_children"]!="undefined"&&n.children("ul:eq(0)").children("li").size()+1>n.metadata().max_children)return this.error("CREATE: MAX_CHILDREN REACHED");var c=!0;(typeof e(n).metadata().max_depth).toLowerCase()!="undefined"&&e(n).metadata().max_depth===0?c=!1:n.parents("li").each(function(t){if(e(this).metadata().max_depth&&t+1>=e(this).metadata().max_depth)return c=!1,!1});if(!c)return this.error("CREATE: MAX_DEPTH REACHED")}if((typeof r).toLowerCase()=="undefined"||r=="inside")r=this.settings.rules.createat=="top"?0:n.children("ul:eq(0)").children("li").size();if(n.children("ul").size()==0||i==1&&n.children("ul").children("li").size()==0)if(!i)var h=this.moved(f,n.children("a:eq(0)"),"inside",!0);else var h=this.moved(f,this.container.children("ul:eq(0)"),"inside",!0);else if(n.children("ul:eq(0)").children("li:nth-child("+(r+1)+")").size())var h=this.moved(f,n.children("ul:eq(0)").children("li:nth-child("+(r+1)+")").children("a:eq(0)"),"before",!0);else var h=this.moved(f,n.children("ul:eq(0)").children("li:last").children("a:eq(0)"),"after",!0);return h===!1?this.error("CREATE: ABORTED"):(this.select_branch(f.children("a:eq(0)")),u&&this.rename(),f)},rename:function(t){if(this.locked)return this.error("LOCKED");t=t?this.get_node(t):this.selected;var n=this;if(!t||!t.size())return this.error("RENAME: NO NODE SELECTED");if(!this.check("renameable",t))return this.error("RENAME: NODE NOT RENAMABLE");if(!this.settings.callback.beforerename.call(null,t.get(0),n.current_lang,n))return this.error("RENAME: STOPPED BY USER");t.parents("li.closed").each(function(){n.open_branch(this)}),this.current_lang?t=t.find("a."+this.current_lang).get(0):t=t.find("a:first").get(0),last_value=t.innerHTML,n.inp=e("<input type='text' autocomplete='off' />"),n.inp.val(last_value.replace(/&amp;/g,"&").replace(/&gt;/g,">").replace(/&lt;/g,"<")).bind("mousedown",function(e){e.stopPropagation()}).bind("mouseup",function(e){e.stopPropagation()}).bind("click",function(e){e.stopPropagation()}).bind("keyup",function(e){var t=e.keyCode||e.which;if(t==27){this.value=last_value,this.blur();return}if(t==13){this.blur();return}});var r={};r[this.container.attr("id")]=this.get_rollback(),n.inp.blur(function(i){this.value==""&&(this.value=last_value),e(t).text(e(t).parent().find("input").eq(0).attr("value")).get(0).style.display="",e(t).prevAll("span").remove(),n.settings.callback.onrename.call(null,n.get_node(t).get(0),n.current_lang,n,r),n.inp=!1});var i=e("<span />").addClass(t.className).append(n.inp);i.attr("style",e(t).attr("style")),t.style.display="none",e(t).parent().prepend(i),n.inp.get(0).focus(),n.inp.get(0).select()},remove:function(t){if(this.locked)return this.error("LOCKED");var n={};n[this.container.attr("id")]=this.get_rollback();if(t&&(!this.selected||this.get_node(t).get(0)!=this.selected.get(0))){t=this.get_node(t);if(t.size()){if(!this.check("deletable",t))return this.error("DELETE: NODE NOT DELETABLE");if(!this.settings.callback.beforedelete.call(null,t.get(0),s))return this.error("DELETE: STOPPED BY USER");$parent=t.parent(),t=t.remove(),$parent.children("li:last").addClass("last"),$parent.children("li").size()==0&&($li=$parent.parents("li:eq(0)"),$li.removeClass("open").removeClass("closed").addClass("leaf").children("ul").remove(),this.set_cookie("open")),this.settings.callback.ondelete.call(null,t.get(0),this,n)}}else{if(!this.selected)return this.error("DELETE: NO NODE SELECTED");if(!this.check("deletable",this.selected))return this.error("DELETE: NODE NOT DELETABLE");if(!this.settings.callback.beforedelete.call(null,this.selected.get(0),s))return this.error("DELETE: STOPPED BY USER");$parent=this.selected.parent();var t=this.selected;if(this.settings.rules.multiple==0||this.selected_arr.length==1)var r=!0,i=this.selected.prev("li:eq(0)").size()?this.selected.prev("li:eq(0)"):this.selected.parents("li:eq(0)");t=t.remove(),$parent.children("li:last").addClass("last"),$parent.children("li").size()==0&&($li=$parent.parents("li:eq(0)"),$li.removeClass("open").removeClass("closed").addClass("leaf").children("ul").remove(),this.set_cookie("open")),this.settings.callback.ondelete.call(null,t.get(0),this,n),r&&i&&this.select_branch(i);if(this.settings.rules.multiple!=0&&!r){var s=this;this.selected_arr=[],this.container.find("a.clicked").filter(":first-child").parent().each(function(){s.selected_arr.push(e(this))}),this.selected_arr.length>0&&(this.selected=this.selected_arr[0],this.remove())}}},get_next:function(t){var n=this.hovered||this.selected;if(n)return n.hasClass("open")?t?this.select_branch(n.find("li:eq(0)")):this.hover_branch(n.find("li:eq(0)")):e(n).nextAll("li").size()>0?t?this.select_branch(n.nextAll("li:eq(0)")):this.hover_branch(n.nextAll("li:eq(0)")):t?this.select_branch(n.parents("li").next("li").eq(0)):this.hover_branch(n.parents("li").next("li").eq(0))},get_prev:function(e){var t=this.hovered||this.selected;if(t){if(t.prev("li").size()){var t=t.prev("li").eq(0);while(t.hasClass("open"))t=t.children("ul:eq(0)").children("li:last");return e?this.select_branch(t):this.hover_branch(t)}return e?this.select_branch(t.parents("li:eq(0)")):this.hover_branch(t.parents("li:eq(0)"))}},get_left:function(e,t){if(this.settings.ui.rtl&&!t)return this.get_right(e,!0);var n=this.hovered||this.selected;if(n){if(!n.hasClass("open"))return e?this.select_branch(n.parents("li:eq(0)")):this.hover_branch(n.parents("li:eq(0)"));this.close_branch(n)}},get_right:function(e,t){if(this.settings.ui.rtl&&!t)return this.get_left(e,!0);var n=this.hovered||this.selected;if(n){if(!n.hasClass("closed"))return e?this.select_branch(n.find("li:eq(0)")):this.hover_branch(n.find("li:eq(0)"));this.open_branch(n)}},toggleDots:function(){this.container.toggleClass("no_dots")},set_cookie:function(t){if(this.settings.cookies===!1)return!1;if(this.settings.cookies[t]===!1)return!1;switch(t){case"selected":if(this.settings.rules.multiple!=0&&this.selected_arr.length>1){var n=Array();e.each(this.selected_arr,function(){n.push(this.attr("id"))}),n=n.join(",")}else var n=this.selected?this.selected.attr("id"):!1;e.cookie(this.settings.cookies.prefix+"_selected",n,this.settings.cookies.opts);break;case"open":var r="";this.container.find("li.open").each(function(e){r+=this.id+","}),e.cookie(this.settings.cookies.prefix+"_open",r.replace(/,$/ig,""),this.settings.cookies.opts)}},get_rollback:function(){var e={};return this.context.remove&&this.context.apply_to&&this.context.apply_to.children("a").removeClass("clicked"),e.html=this.container.html(),this.context.remove&&this.context.apply_to&&this.context.apply_to.children("a").addClass("clicked"),e.selected=this.selected?this.selected.attr("id"):!1,e},moved:function(n,r,i,s,o,u){var n=e(n),a=e(n).parents("ul:eq(0)"),f=e(r);if(!u){var u={};u[this.container.attr("id")]=this.get_rollback();if(!s){var l=n.size()>1?n.eq(0).parents(".tree:eq(0)"):n.parents(".tree:eq(0)");l.get(0)!=this.container.get(0)&&(l=t.inst[l.attr("id")],u[l.container.attr("id")]=l.get_rollback()),delete l}}if(i=="inside"&&this.settings.data.async&&this.get_node(f).hasClass("closed")){var c=this;return this.open_branch(this.get_node(f),!0,function(){c.moved.apply(c,[n,r,i,s,o,u])})}if(n.size()>1){var c=this,l=this.moved(n.eq(0),r,i,!1,o,u);n.each(function(e){if(e==0)return;l&&(l=c.moved(this,l.children("a:eq(0)"),"after",!1,o,u))});return}o?(_what=n.clone(),_what.each(function(t){this.id=this.id+"_copy",e(this).find("li").each(function(){this.id=this.id+"_copy"}),e(this).removeClass("dragged").find("a.clicked").removeClass("clicked ui-state-active").end().find("li.dragged").removeClass("dragged")})):_what=n;if(s){if(!this.settings.callback.beforecreate.call(null,this.get_node(n).get(0),this.get_node(r).get(0),i,this))return!1}else if(!this.settings.callback.beforemove.call(null,this.get_node(n).get(0),this.get_node(r).get(0),i,this))return!1;if(!s){var l=n.parents(".tree:eq(0)");if(l.get(0)!=this.container.get(0)){l=t.inst[l.attr("id")];if(l.settings.languages.length){var h=[];if(this.settings.languages.length==0)h.push("."+l.current_lang);else for(var p in this.settings.languages)for(var d in l.settings.languages)this.settings.languages[p]==l.settings.languages[d]&&h.push("."+this.settings.languages[p]);if(h.length==0)return this.error("MOVE: NO COMMON LANGUAGES");n.find("a").not(h.join(",")).remove()}n.find("a.clicked").removeClass("clicked ui-state-active")}}n=_what;switch(i){case"before":f.parents("ul:eq(0)").children("li.last").removeClass("last"),f.parent().before(n.removeClass("last")),f.parents("ul:eq(0)").children("li:last").addClass("last");break;case"after":f.parents("ul:eq(0)").children("li.last").removeClass("last"),f.parent().after(n.removeClass("last")),f.parents("ul:eq(0)").children("li:last").addClass("last");break;case"inside":f.parent().children("ul:first").size()?this.settings.rules.createat=="top"?f.parent().children("ul:first").prepend(n.removeClass("last")).children("li:last").addClass("last"):f.parent().children("ul:first").children(".last").removeClass("last").end().append(n.removeClass("last")).children("li:last").addClass("last"):(n.addClass("last"),f.parent().append("<ul/>").removeClass("leaf").addClass("closed"),f.parent().children("ul:first").prepend(n)),f.parent().hasClass("closed")&&this.open_branch(f);break;default:}if(a.find("li").size()==0){var v=a.parent();v.removeClass("open").removeClass("closed").addClass("leaf").children("ul").remove(),v.parents("ul:eq(0)").children("li.last").removeClass("last").end().children("li:last").addClass("last"),this.set_cookie("open")}else a.children("li.last").removeClass("last"),a.children("li:last").addClass("last");return o?this.settings.callback.oncopy.call(null,this.get_node(n).get(0),this.get_node(r).get(0),i,this,u):s?this.settings.callback.oncreate.call(null,this.get_node(n).get(0),f.is("ul")?-1:this.get_node(r).get(0),i,this,u):this.settings.callback.onmove.call(null,this.get_node(n).get(0),this.get_node(r).get(0),i,this,u),n},error:function(e){return this.settings.callback.error.call(null,e,this),!1},lock:function(e){this.locked=e,this.locked?this.container.addClass("locked"):this.container.removeClass("locked")},cut:function(e){if(this.locked)return this.error("LOCKED");e=e?this.get_node(e):this.container.find("a.clicked").filter(":first-child").parent();if(!e||!e.size())return this.error("CUT: NO NODE SELECTED");this.copy_nodes=!1,this.cut_nodes=e},copy:function(e){if(this.locked)return this.error("LOCKED");e=e?this.get_node(e):this.container.find("a.clicked").filter(":first-child").parent();if(!e||!e.size())return this.error("COPY: NO NODE SELECTED");this.copy_nodes=e,this.cut_nodes=!1},paste:function(e,t){if(this.locked)return this.error("LOCKED");e=e?this.get_node(e):this.selected;if(!e||!e.size())return this.error("PASTE: NO NODE SELECTED");if(!this.copy_nodes&&!this.cut_nodes)return this.error("PASTE: NOTHING TO DO");var n=this;if(t=="before")t=ref_node.parent().children().index(e),e=e.parents("li:eq(0)");else if(t=="after")t=e.parent().children().index(e)+1,e=e.parents("li:eq(0)");else if((typeof t).toLowerCase()=="undefined"||t=="inside")t=this.settings.rules.createat=="top"?0:e.children("ul:eq(0)").children("li").size();if(this.copy_nodes&&this.copy_nodes.size()){var r=!0;e.parents().andSelf().each(function(){if(n.copy_nodes.index(this)!=-1)return r=!1,!1});if(!r)return this.error("Invalid paste");if(!this.checkMove(this.copy_nodes,e.children("a:eq(0)"),"inside"))return!1;if(e.children("ul").size()==0)var i=this.moved(this.copy_nodes,e.children("a:eq(0)"),"inside",!1,!0);else if(e.children("ul:eq(0)").children("li:nth-child("+(t+1)+")").size())var i=this.moved(this.copy_nodes,e.children("ul:eq(0)").children("li:nth-child("+(t+1)+")").children("a:eq(0)"),"before",!1,!0);else var i=this.moved(this.copy_nodes,e.children("ul:eq(0)").children("li:last").children("a:eq(0)"),"after",!1,!0);this.copy_nodes=!1}if(this.cut_nodes&&this.cut_nodes.size()){var r=!0;e.parents().andSelf().each(function(){if(n.cut_nodes.index(this)!=-1)return r=!1,!1});if(!r)return this.error("Invalid paste");if(!this.checkMove(this.cut_nodes,e.children("a:eq(0)"),"inside"))return!1;if(e.children("ul").size()==0)var i=this.moved(this.cut_nodes,e.children("a:eq(0)"),"inside");else if(e.children("ul:eq(0)").children("li:nth-child("+(t+1)+")").size())var i=this.moved(this.cut_nodes,e.children("ul:eq(0)").children("li:nth-child("+(t+1)+")").children("a:eq(0)"),"before");else var i=this.moved(this.cut_nodes,e.children("ul:eq(0)").children("li:last").children("a:eq(0)"),"after");this.cut_nodes=!1}},search:function(t){var n=this;if(!t||this.srch&&t!=this.srch)this.srch="",this.srch_opn=!1,this.container.find("a.search").removeClass("search ui-state-highlight");this.srch=t;if(!t)return;if(this.settings.data.async)if(!this.srch_opn){var r=e.extend({search:t},this.settings.data.async_data(!1));e.ajax({type:this.settings.data.method,url:this.settings.data.url,data:r,dataType:"text",success:function(r){n.srch_opn=e.unique(r.split(",")),n.search.apply(n,[t])}})}else if(this.srch_opn.length){if(this.srch_opn&&this.srch_opn.length){var i=!1;for(var s=0;s<this.srch_opn.length;s++)if(this.get_node("#"+this.srch_opn[s]).size()>0){i=!0;var o="#"+this.srch_opn[s];delete this.srch_opn[s],this.open_branch(o,!0,function(){n.search.apply(n,[t])})}i||(this.srch_opn=[],n.search.apply(n,[t]))}}else{var u="a";this.settings.languages.length&&(u+="."+this.current_lang),this.container.find(u+":contains('"+t+"')").addClass(this.settings.ui.theme_name=="themeroller"?"search ui-state-highlight":"search"),this.srch_opn=!1}else{var u="a";this.settings.languages.length&&(u+="."+this.current_lang),this.container.find(u+":contains('"+t+"')").addClass(this.settings.ui.theme_name=="themeroller"?"search ui-state-highlight":"search").parents("li.closed").each(function(){n.open_branch(this,!0)})}},destroy:function(){this.container.unbind().find("li").die().find("a").die(),this.container.removeClass("tree ui-widget ui-widget-content").children("ul").removeClass("tree-"+this.settings.ui.theme_name).find("li").removeClass("leaf").removeClass("open").removeClass("closed").removeClass("last").children("a").removeClass("clicked hover search ui-state-active ui-state-hover ui-state-highlight ui-state-default");if(this.cntr==t.focused)for(var e in t.inst)if(e!=this.cntr&&e!=this.container.attr("id")){t.inst[e].focus();break}delete t.inst[this.cntr],delete t.inst[this.container.attr("id")],t.cntr--}}}e.fn.tree=function(n){return this.each(function(){var r=e.extend({},n);t.inst&&t.inst[e(this).attr("id")]&&t.inst[e(this).attr("id")].destroy(),r!==!1&&(new t).init(this,r)})},e.tree_create=function(){return new t},e.tree_focused=function(){return t.inst[t.focused]},e.tree_reference=function(e){return t.inst[e]||null},e.tree_rollback=function(n){for(var r in n){var i=t.inst[r],s=!i.locked;s&&i.lock(!0),i.inp&&i.inp.val("").blur(),i.context.append=!1,i.container.html(n[r].html).find(".dragged").removeClass("dragged").end().find("div.context").remove(),n[r].selected&&(i.selected=e("#"+n[r].selected),i.selected_arr=[],i.container.find("a.clicked").each(function(){i.selected_arr.push(i.get_node(this))})),s&&i.lock(!1),delete s,delete i}}})(jQuery);